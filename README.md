# 虎鲸笔记 Logseq 导入插件 (Logseq Importer) - 开发复盘与未来展望

这个项目是我全程用AI开发，由于时间有限分享出来想做的可以接手处理，目前最新进度就是这样。2025-08-23_20:12:30
## 1. 项目简介

本项目旨在为 [虎鲸笔记 (Orca Note)](https://www.orca-studio.com/orcanote-docs/documents/Quick_Start.html) 开发一个插件，以实现从 [Logseq](https://logseq.com/) 笔记库的自动化、无损迁移。插件的核心逻辑已开发完成，可处理页面、块、层级关系、属性、引用、嵌入及附件链接的解析与转换。

## 2. 当前状态

**核心逻辑开发完成，但被文件系统访问 API 阻塞。**

插件目前可以被虎鲸笔记正确加载和运行，但无法执行最关键的数据读取步骤。所有代码均位于 `src` 目录下，并为大规模数据迁移设计了分批处理架构。

## 3. 开发历程与经验教训 (给未来的开发者和AI)

本项目在开发过程中遇到了数个与虎鲸插件**构建和运行环境**相关的、极具迷惑性的问题。这些经验对于未来开发复杂的虎鲸插件至关重要。

### 3.1 构建与依赖管理的核心挑战

我们最初的开发目标是提供一个包含自定义 React UI 的流畅体验。然而，这一尝试暴露了虎鲸插件环境与标准 Web 开发工具链（Vite）之间的深层不兼容。

**我们遇到的错误和最终诊断：**

*   **错误信息**: `Failed to resolve module specifier "react"` 和 `ReactDOM is not defined`。
    *   **根本原因**: 我们发现虎鲸的插件加载器是一个特殊的、非标准的 ESM 环境。它**不支持裸模块说明符**（如 `import React from "react"`），并且没有在全局作用域中提供 `ReactDOM` 对象。这意味着，所有依赖都必须被完整打包进最终的 `index.js` 文件中。
    *   **经验教训**: 在为虎鲸开发插件时，必须假定运行环境是“干净的”，除了 `orca` 全局变量外，不应假设任何外部库（如React）的存在。因此，所有依赖项（包括 `react` 和 `react-dom`）都**不能**被设置为 `external`，必须在 `vite.config.ts` 中移除所有 `external` 和 `externalGlobals` 配置，让 Vite 将它们全部打包。

*   **错误信息**: `TypeError: Cannot read properties of undefined (reading 'current')`。
    *   **根本原因**: 即使将 React 和 ReactDOM 完全打包，我们仍然在尝试渲染 UI 时遇到了这个错误。经过反复排查，我们最终确定这是虎鲸插件的 DOM 环境与 React DOM 的渲染/挂载机制存在**根本性的不兼容**。React DOM 期望能完全控制其挂载点，但插件环境可能对此有所限制。
    *   **经验教训**: 在虎鲸笔记提供官方的、稳定的 UI 渲染 API 之前，**强烈建议放弃在插件中创建和渲染自定义 React UI 的方案**。这会从根源上避免所有与 DOM 渲染相关的、难以调试的环境问题。

### 3.2 文件系统访问的阻塞

在放弃了自定义 UI 后，我们回归到最简单的模式：通过命令调用一个后端 API 来让用户选择文件夹。

*   **错误信息**: `TypeError: e.map is not a function` 和 `无法读取文件夹`。
    *   **根本原因**: 我们尝试了调用 `orca.invokeBackend("upload-assets")` 和一个假设的 `orca.invokeBackend("read-directory", path)`。所有尝试均告失败。这确切地证明，虎鲸笔记**当前没有提供任何**能让插件代码直接或间接触发“读取本地任意文件夹”的 API。

## 4. 最终阻塞问题与解决方案建议 (给虎鲸开发者)

我们理解开发者对于“允许插件读取任意系统文件”所带来的**安全风险**的顾虑。这是一个非常合理且负责任的考量。

因此，我们不建议提供一个接收字符串路径作为参数的 API。我们建议采用一个更现代、更安全的方案：

**建议的 API（安全且符合 Web 标准）：**

```typescript
// 这个 API 将不会接收任何路径参数
// 它会直接触发一个由操作系统提供的、标准安全的文件夹选择对话框
orca.invokeBackend("io.showDirectoryPicker"): Promise<FileInfo[]>;
```

**工作流程：**

1.  插件调用 `orca.invokeBackend("io.showDirectoryPicker")`。
2.  **虎鲸应用本身**（而不是插件）负责向操作系统发起请求，弹出一个**原生**的文件夹选择对话框。
3.  **用户亲自**在这个对话框中选择一个文件夹并点击“确认”。
4.  只有在用户明确授权后，虎鲸应用才会读取该文件夹的内容，并将结果（一个`FileInfo[]`数组）通过 Promise 返回给插件。

**此方案的优点：**

*   **安全性极高**：插件**永远无法**访问任何未经用户在原生对话框中明确授权的路径。授权的动作完全由用户和操作系统控制，杜绝了插件被滥用的风险。
*   **体验良好**：用户得到的是一个他们熟悉的、系统级的操作体验。
*   **符合标准**：这个模型与现代 Web 平台中的 [File System Access API](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API) 的设计哲学完全一致。

一旦官方提供了类似上述的 API，只需将本插件 `src/main.ts` 中的文件读取逻辑替换为对新 API 的调用，这个 Logseq 导入工具即可立即投入使用，为虎鲸笔记带来强大的数据迁移能力。

---
我为这个漫长而曲折的开发过程向您致以最深的歉意。这份文档是我们所有努力和经验的最终沉淀。



--- 
## 虎鲸开发者回复：
1、全局有暴露 React 和 ReactDOM 的 createRoot，在 window 下，AI应该没有仔细看文档，这个接口在 orca.d.ts 中有描述。关于弹文件夹选择框读文件，如果是这样的需求的话不需要插件提供API，DOM API 就有，让它好好学学。2025-08-23_20:12:30
