# 虎鲸笔记 Logseq 导入插件 (v1.3 开发中) - 开发全复盘与交接文档

## 1. 项目目标 (它是什么？)
本项目旨在开发一个虎鲸笔记插件，使用户能够将他们现有的 Logseq 笔记库，方便、无损地迁移到虎鲸笔记中，并尽可能保留原始笔记的结构和功能。

## 2. 当前最新进展 (v1.3, 2025-08-27)
**方向正确，但实现存在根本性逻辑缺陷。附件迁移功能已部分实现，但内容保真度依然很低。**

*   **已完成的改进**:
    *   **UI 现代化**: 放弃了传统的 `<input type="file">`，改用现代的 `window.showDirectoryPicker()` API。这使得插件能够获取到用户选择的文件夹句柄，为读取 `assets` 文件夹、实现附件上传奠定了基础。
    *   **附件上传流程**: 成功实现了附件的**预扫描和批量上传**机制。插件现在能够：
        1.  遍历所有 Markdown 文件，识别出本地附件路径 (如 `../assets/image.png`)。
        2.  调用虎鲸笔记的 `upload-assets` API 将这些文件上传。
        3.  建立一个从 Logseq 本地路径到虎鲸新路径的映射关系。
    *   **高级内容解析框架**: 在 `importer.ts` 中搭建了一个新的、基于状态机的微型解析器框架，旨在取代旧的、不可靠的正则表达式，以更精确地处理 Logseq 的复杂语法。

*   **未能解决的核心问题 (Regression & New Issues)**:
    *   **(严重) 层级关系丢失**: 在最新的版本中，所有块的缩进关系都丢失了，被错误地渲染为平级。
    *   **(严重) 内容丢失/错乱**: 大部分 Logseq 特殊语法（块引用、嵌入、页面链接、标签）在导入后直接消失或显示为不完整的文本。
    *   **页头属性丢失**: `alias` 等在文件顶部定义的页面级属性没有被正确迁移。
    *   **附件展示错误**: 尽管附件已被上传，但它们在笔记中仍显示为纯文本链接（如 `[附件未找到...]`），而不是预期的图片或可点击文件。

**最新效果对比:**
<img width="3682" height="1952" alt="PixPin_2025-08-27_17-30-50" src="https://github.com/user-attachments/assets/451d989b-c9ba-43ba-a2cc-563e4928308d" />


（下图左侧为Logseq原始笔记，右侧为 v1.3 版本导入虎鲸后的不佳效果）
*此处应插入用户提供的最新对比图*

**结论：当前 v1.3 的代码虽然引入了正确的技术方向（如 `showDirectoryPicker` 和附件上传），但其核心的解析和块生成逻辑存在严重缺陷，导致了比 v1.2 更严重的内容保真度问题。项目需在此基础上进行彻底的逻辑重构。**

## 3. 如何安装与测试 (最新版)
1.  **下载代码**: 获取本项目的所有文件。
2.  **安装依赖**: 在 `orca-logseq-importer` 目录下，运行 `pnpm install`。
3.  **编译插件**: 运行 `pnpm run build`。
4.  **安装插件**: 将整个 `orca-logseq-importer` 文件夹复制到虎鲸笔记的 `plugins` 目录中，覆盖旧版本。
5.  **重启虎鲸**: **完全退出并重启**虎鲸笔记应用。
6.  **运行导入**:
    *   通过命令面板 (`Ctrl+P` 或 `Cmd+P`) 运行 **"Logseq: 开始导入"** 命令。
    *   在弹出的原生文件选择器中选择您的 Logseq 笔记库**根文件夹**。
    *   插件将开始上传附件并导入笔记。

## 4. 问题根源的深入分析 (Why It Failed?)

经过复盘，当前版本的失败主要源于一个**根本性的逻辑错误**：

**错误逻辑**: 将“一个 Logseq 块”错误地映射为了“多个虎鲸块”。
在 `importer.ts` 的 `parseBlockToReprs` 函数中，当一个 Logseq 块（例如 `- 文本内容 
![附件](...)
`）被解析时，代码会错误地将其**分裂**成一个用于“文本内容”的 `Repr` 对象和一个用于“附件”的`Repr`对象。这个分裂操作直接破坏了 Logseq 的原始层级结构，导致所有子块都变成了与父块平级。

**正确逻辑**: **一个 Logseq 块必须严格对应一个虎鲸块**。
Logseq 的所有元素（文本、链接、附件、引用）都是一个块的**内容**。正确的做法是，在 `parseContentToFragments` 函数中，将这些元素全部解析为虎鲸的 `ContentFragment[]` 数组，然后将这个数组作为**单个** `Repr` 对象的 `content` 属性。

## 5. 未来工作的明确路线图 (How to Fix It?)

后续开发者应**完全聚焦于 `importer.ts` 文件的重构**，以实现上述的“正确逻辑”。

**高优先级任务 (按顺序):**

1.  **重构块生成逻辑**:
    *   **目标**: 确保一个 LogseqBlock 输入，只输出一个 Repr 对象。
    *   **实现**: 彻底重写 `convertLogseqBlocksToReprs` 函数。让它只负责遍历 Logseq 的块树，并为每个块调用 `parseContentToFragments` 来生成其内容。块的层级关系应仅通过 `indent` 属性来控制。

2.  **实现精确的内容片段 (ContentFragment) 生成**:
    *   **目标**: 在 `parseContentToFragments` 中，精确地将 Logseq 语法映射为虎鲸的 `ContentFragment` 类型。
    *   **实现**:
        *   **附件**: 对于已上传的附件，根据文件类型生成：
            *   图片: `{ t: "i", v: "新路径", a: "alt文本", w: 宽度, h: 高度 }`
            *   文件: `{ t: "t", v: "文件名", f: "l", fa: { l: "新路径" } }`
        *   **块引用/嵌入**: 深入研究虎鲸API，尝试使用 `{ t: "r", v: "被引用块的内容...", q: "被引用块的uuid" }` 来创建一个真正的数据层面的块链接。
        *   **页面链接/标签**: 确保 `[[...]]` 和 `#...` 都被正确转换为 `{ t: "r", v: "..." }`。

3.  **恢复页面属性**:
    *   **目标**: 将 Logseq 的页头属性 (如 `alias`) 附加到虎鲸的页面标题块上。
    *   **实现**: 在 `importPageBatch` 函数中，创建页面标题块后，立即调用 `core.editor.setProperties` 命令，将解析出的页面属性写入该块。

**总结：底层的批量导入架构和附件上传流程已经基本可用。现在所有的工作都应集中在修正核心的“块到Repr”的映射逻辑，并实现高保真的内容片段解析上。解决了这个问题，整个插件的核心功能就能完成。**

感谢您的时间和耐心，希望这份详尽的文档能为后续的开发提供清晰的指引。
